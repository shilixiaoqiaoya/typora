## 什么是运行时和编译时

### 编译时

指在开发阶段将源代码转化为最终可执行代码的过程。在一些前端框架中，编译时可能会进行模板编译、代码优化、静态类型检查等操作。这些步骤旨在提前检查错误、生成最终的代码，以便在运行时获得更好的性能和用户体验。典型的编译时框架有typescript，svelte等

编译时的概念被分为即时编译（JIT）和预编译（AOT）：

- 即时编译（JIT）：Just In Time，在宿主环境中边编译边执行，angular的编译器就提供了两种编译方案。
- 预编译（AOT）：Ahead Of Time，编译完成之后在宿主环境中执行，目前前端框架的AOT方案主要有两种，就是vue和react的模板语法和jsx

预编译的好处是可以拥有更短的运行时间， 大多数框架都采用了AOT编译技术，因为预编译（AOT）的特点，采用AOT编译技术的框架，可以对开发者的代码做充分的分析，从而有更大的优化空间。



### 运行时

指在浏览器中实际执行和运行的代码。当用户访问一个网页或应用时，前端框架的代码会在浏览器中被解释和执行，从而呈现出界面和交互效果。例如，Vue 和 React 运行时负责管理组件的生命周期、状态变化、事件处理等。运行时的部分可能涉及虚拟 DOM 操作，如vue和 React 的虚拟 DOM 的diff和更新等。





## 重运行时的react

React采用Jsx方案编译，由于Jsx语法过于灵活，导致在编译时，React可以做的优化有限，所以，React将很多工作放在了运行时阶段。

1. JSX 语法： React 引入了 JSX 语法，允许在 JavaScript 代码中编写类似于 XML 的结构化代码。JSX 使得组件的结构和渲染变得更直观，提高了开发效率。
2. 编译时优化有限： 尽管 JSX 提供了更直观的组件描述方式，但其灵活性也带来了编译时优化的限制。由于 JSX 可以包含各种 JavaScript 表达式和逻辑，编译时对 JSX 进行深度的静态分析和优化变得复杂。这可能限制了在编译时做出更多优化的能力。
3. 运行时优化： 鉴于编译时优化的限制，React 将许多优化工作放在了运行时阶段。在数据发生变化后，并没有直接去操作 dom，而是生成一个新的虚拟 dom树，它可以帮助我们解决跨平台和兼容性问题，并且通过 diff 算法得出最小的操作行为，这些全部都是在运行时来做的
4. React Fiber： React Fiber 是 React 内部自己实现的一种架构（时间分片），可以让渲染更新过程被中断，将控制权交回给浏览器，让位给高优先级的任务（比如用户的点击反馈或者上下滑事件），浏览器空闲后再恢复渲染。这也是 React 在运行时进行优化和调度的一个重要部分。





## 重编译时的svelte

svelte是一个典型的重编译的框架，作为开发者我们只需要去写模版和数据，经过 Svelte 的编译和预处理，代码基本全部会解析成原生的 DOM 操作，Svelte 的性能也是最接近原生 js 的。

svelte主要做了以下几步：

1. Acorn 和 AST（抽象语法树）： Acorn 是 JavaScript 解析器，用于将 JavaScript 代码解析成抽象语法树（AST）。Svelte 使用 Acorn 将组件中的 JavaScript 代码转化为 AST，这使得 Svelte 可以深入理解代码的结构和语义。
2. 编译赋值语句和数据更新逻辑： 在编译阶段，Svelte 会分析赋值语句并额外生成数据更新逻辑。这是因为 Svelte 的编译时优化模型需要知道哪些数据变化会触发组件的重新渲染，从而生成相应的更新逻辑。
3. 编译变量声明和上下文数组： 在编译变量声明时，Svelte 会将变量编译成上下文数组。这种方式有助于在运行时更有效地管理组件状态和变量，以实现高效的数据更新。
4. 编译模板和生成更新逻辑： Svelte 在编译模板时会标记依赖，并为每个变量引用生成更新逻辑。这样，当数据发生变化时，Svelte 可以根据依赖关系自动更新相应的部分，而不需要重新渲染整个组件。
5. 编译型框架的优势： Svelte 被称为编译型框架，因为它在编译阶段就完成了大部分运行时逻辑。这使得生成的运行时代码非常轻量级，有利于首屏加载和渲染性能。相比传统的虚拟 DOM 模型，Svelte 的编译型优化可以减少运行时的开销，提供更快的交互和响应性





## 平衡大师vue

vue在运行时和预编译取了一个很好地权衡，它保留了虚拟 dom，但是会通过响应式去控制虚拟 dom 的颗粒度，在预编译里面，又做了足够多的性能优化，做到了按需更新。

### 编译时优化

vue的编译时优化主要分为以下几步：

- diff的改良，传统diff存在很多无意义的操作，比如每次diff都会重复遍历静态节点，造成性能浪费，所以vue采用了patchFlags来标记静态节点，并且用掩码标记该属性是否是动态节点。
- 静态提升：将静态节点提升到render函数之外，避免重复渲染
- 预字符串化：多个标签会产生重复代码，因此将这些静态节点序列化为字符串，减少虚拟DOM的创建带来的性能开销，减少内存占用
- 缓存内联事件处理函数：避免函数的重复创建  类似react的useCallback?



### 运行时

vue的运行时主要是针对的虚拟DOM相关操作

- 创建虚拟DOM树
- 响应式数据绑定
- 将虚拟DOM转化为真实DOM
- 处理用户交互事件：Vue 运行时负责捕获用户的交互事件，并将其映射到组件上定义的方法和事件处理程序。
- 生命周期的调用